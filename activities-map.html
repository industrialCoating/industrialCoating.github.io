<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activities Map</title>

    <!-- Leaflet CSS - Required for map styling -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
          
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />


    <style>
        /* Basic styling for the page */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Inter', sans-serif; /* Using a clean, modern font */
            overflow: hidden;
        }
        /* Homepage Link Bar */
        .homepage-link {
            text-align: center;
            padding: 10px;
            background-color: #1b1b1b;
            font-size: 16px;
            border-bottom: 1px solid #000;
        }
        .homepage-link a {
            color: #fcfcfc;
            text-decoration: none;
            font-weight: 500;
        }
        /* The map container must have a defined height */
        #map {
            height: 100%;
            width: 100%;
            background-color: #f0f0f0; /* Fallback color */
        }
        
        /* Base styling for our custom emoji icons */
        .emoji-icon {
            text-align: center;
            line-height: 1; /* Ensures emoji is centered vertically */
        }

        /* Custom icon for player locations from the CSV */
        .player-icon {
            background-color: #f97316; /* A nice orange color */
            border-radius: 50%; /* Makes it a circle */
            border: 1px solid #fff;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        /* Style for the layer control (legend) */
        .leaflet-control-layers {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
            padding: 10px;
        }
        
        /* Increase touch target size for mobile */
        .leaflet-control-layers-overlays label {
            display: flex;
            align-items: center;
            padding: 5px;
            font-size: 16px; /* Larger text */
            cursor: pointer;
        }

        /* Make the checkbox itself larger */
        .leaflet-control-layers-selector {
            transform: scale(1.5);
            margin-right: 15px; /* More space between checkbox and label */
        }

        /* Style for the orange dot icon in the legend */
        .player-icon-legend {
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-right: 8px;
        }

        /* Style for emoji icons in the legend */
        .emoji-icon-legend {
            font-size: 20px;
            margin-right: 8px;
        }

        /* Custom Cluster Styling */
        .marker-cluster-small, .marker-cluster-medium {
            background-color: rgba(74, 222, 128, 0.8); /* Green */
        }
        .marker-cluster-small div, .marker-cluster-medium div {
            background-color: rgba(34, 197, 94, 0.8);
        }

        .marker-cluster-large {
            background-color: rgba(34, 197, 94, 0.8); /* Green */
        }
        .marker-cluster-large div {
            background-color: rgba(22, 163, 74, 0.8);
        }
        
        .marker-cluster-xlarge {
            background-color: rgba(22, 101, 52, 0.8); /* Dark Green */
        }
        .marker-cluster-xlarge div {
            background-color: rgba(21, 128, 61, 0.8);
        }

        .marker-cluster {
            color: #fff;
            border-radius: 50%;
            text-align: center;
            font-weight: bold;
            line-height: 30px;
            /* Added text shadow for better readability */
            text-shadow: 1px 1px 2px black;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Homepage Link -->
    <div class="homepage-link">
        <a href="https://703warriors.com">← Return to Homepage</a>
    </div>
    <!-- The div element where the map will be rendered -->
    <div id="map"></div>

    <!-- Leaflet JS - The core mapping library -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <!-- Esri Leaflet JS - Plugin to easily use Esri services (like basemaps) -->
    <script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"
            crossorigin=""></script>
            
    <!-- Leaflet MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
        // --- 1. INITIALIZE THE MAP ---
        const map = L.map('map', { minZoom: 10, maxZoom: 14 }).setView([38.84,-77.08], 10);

        // --- 2. ADD BASEMAP LAYER ---
        L.esri.basemapLayer('Imagery').addTo(map);
        L.esri.basemapLayer('ImageryLabels').addTo(map);

        // --- 3. DEFINE CUSTOM ICONS ---
        const createEmojiIcon = (emoji, size) => {
            return L.divIcon({
                html: `<span class="emoji-icon" style="font-size: ${size}px;">${emoji}</span>`,
                className: '',
                iconSize: [size, size],
                iconAnchor: [size / 2, size],
                popupAnchor: [0, -size]
            });
        };

        const playerIcon = L.divIcon({
            className: 'player-icon',
            iconSize: [15, 15]
        });
        
        const soccerIcon = createEmojiIcon('⚽', 30);
        const icon1 = createEmojiIcon('1️⃣', 40);
        const icon2 = createEmojiIcon('2️⃣', 40);
        const icon3 = createEmojiIcon('3️⃣', 40);
        const icon4 = createEmojiIcon('4️⃣', 40);
        const icon5 = createEmojiIcon('5️⃣', 40);
        const icon6 = createEmojiIcon('6️⃣', 40);
        const icon7 = createEmojiIcon('7️⃣', 40);
        const icon8 = createEmojiIcon('8️⃣', 40);

        // --- 4. CREATE LAYER GROUPS ---
        // Player locations will now be a MarkerClusterGroup
        const playerLocations = L.markerClusterGroup({
            // Reduced radius for tighter clustering. Feel free to adjust this value.
            maxClusterRadius: 35, // Default is 80, previous was 50
            iconCreateFunction: function(cluster) {
                const count = cluster.getChildCount();
                let sizeClass = 'large';
                if (count < 5) {
                    sizeClass = 'small';
                } else if (count < 15) {
                    sizeClass = 'medium';
                } else if (count < 30) {
                    sizeClass = 'large';
                } else {
                    sizeClass = 'xlarge';
                }
                return L.divIcon({
                    html: `<div><span>${count}</span></div>`,
                    className: `marker-cluster marker-cluster-${sizeClass}`,
                    iconSize: [40, 40]
                });
            }
        });
        const practiceLocationLayer = L.layerGroup();
        const tournamentLocations = L.layerGroup();

        // --- 5. ADD SOCCER PRACTICE LOCATION ---
        const practiceLocation = {
            lat: 38.8484737,
            lng: -77.0869135,
            title: "Training",
            icon: soccerIcon
        };
        L.marker([practiceLocation.lat, practiceLocation.lng], { icon: practiceLocation.icon })
            .addTo(practiceLocationLayer)
            .bindPopup(`<b>${practiceLocation.title}</b><br>Wednesday @ 6:30pm<br>Thursday @ 6:30pm<br>Sunday @ 4pm`);

        // --- 6. ADD TOURNAMENT LOCATIONS ---
        const tournaments = [
            { 
                lat: 38.8163, lng: -76.7518, date: "Aug 23 – 24", location: "Annapolis Cup",
                teams: [
                    { name: "2018", url: "https://system.gotsport.com/org_event/events/40581/schedules?team=3367571" },
                    { name: "2015", url: "https://system.gotsport.com/org_event/events/41641/schedules?team=3370756" }
                ],
                icon: icon1
            },
            { 
                lat: 39.1819, lng: -77.3224, date: "Aug 23 – 24", location: "Maryland Premier Cup",
                teams: [
                    { name: "2017", url: "https://system.gotsport.com/org_event/events/45817/schedules?team=3400250" },
                    { name: "2015", url: "https://system.gotsport.com/org_event/events/45817/schedules?team=3371706" }
                ],
                icon: icon1
            },
            { 
                lat: 38.919841, lng: -77.424838, date: "Aug 30 – 31", location: "Copa Villareal",
                teams: [
                    { name: "2015", url: "" },
                    { name: "2017", url: "" }
                ],
                icon: icon2
            },
            { 
                lat: 38.8055, lng: -77.0434, date: "Oct 11 – 12", location: "Alexandria Heritage Cup",
                teams: [
                    { name: "2015", url: "" },
                    { name: "2016", url: "" },
                    { name: "2017", url: "" },
                    { name: "2018", url: "" }
                ],
                icon: icon3
            },
            { 
                lat: 38.9342, lng: -77.1776, date: "Nov 22 – 23", location: "Nation's Capital Cup",
                teams: [
                    { name: "2015", url: "" },
                    { name: "2016", url: "" },
                    { name: "2017", url: "" },
                    { name: "2018", url: "" }
                ],
                icon: icon4
            },
            { 
                lat: 38.88, lng: -77.09, date: "Feb 28 – Mar 1", location: "Arlington Spring Tournament",
                teams: [
                    { name: "2015", url: "" },
                    { name: "2016", url: "" },
                    { name: "2017", url: "" },
                    { name: "2018", url: "" }
                ],
                icon: icon5
            },
            { 
                lat: 38.78, lng: -77.47, date: "Mar 28 – 29", location: "Prince William Courage",
                teams: [
                    { name: "2015", url: "" },
                    { name: "2016", url: "" },
                    { name: "2017", url: "" },
                    { name: "2018", url: "" }
                ],
                icon: icon6
            },
            { 
                lat: 38.78, lng: -77.15, date: "May 23 – 24", location: "SYC Virginian",
                teams: [
                    { name: "2015", url: "" },
                    { name: "2016", url: "" },
                    { name: "2017", url: "" },
                    { name: "2018", url: "" }
                ],
                icon: icon7
            }, 
            { 
                lat: 38.91, lng: -77.04, date: "Jun 20 – 21", location: "DC Cup",
                teams: [
                    { name: "2015", url: "" },
                    { name: "2016", url: "" },
                    { name: "2017", url: "" },
                    { name: "2018", url: "" }
                ],
                icon: icon8
            }
        ];
        tournaments.forEach(tourney => {
            let teamsHtml = "";
            if (Array.isArray(tourney.teams)) {
                teamsHtml = tourney.teams
                    .map(team => `<a href="${team.url}" target="_blank">${team.name}</a>`)
                    .join(", ");
            } else {
                teamsHtml = tourney.teams;
            }

            const popupContent = `<b>${tourney.date}</b><br>${tourney.location}<br><i>Teams: ${teamsHtml}</i>`;
                L.marker([tourney.lat, tourney.lng], { icon: tourney.icon })
                .addTo(tournamentLocations)
                .bindPopup(popupContent);
            });

        // --- 7. FETCH AND PROCESS CSV DATA ---
        const csvUrl = 'https://cdn.jsdelivr.net/gh/yaboyanees/MerzCake@main/PLC3.csv';

        fetch(csvUrl)
            .then(response => response.ok ? response.text() : Promise.reject('Network response was not ok'))
            .then(parseCSVAndAddMarkers)
            .catch(error => {
                console.error('There was a problem fetching the CSV data:', error);
                const errorDiv = L.control({position: 'topright'});
                errorDiv.onAdd = function (map) {
                    const div = L.DomUtil.create('div', 'info legend');
                    div.innerHTML = 'Could not load location data.';
                    div.style.backgroundColor = 'white';
                    div.style.padding = '10px';
                    div.style.borderRadius = '5px';
                    return div;
                };
                errorDiv.addTo(map);
            });
        
        function parseCSVAndAddMarkers(csvText) {
            const rows = csvText.trim().split('\n');
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i].trim();
                if (!row) continue;
                const columns = row.split(',');
                if (columns.length === 3) {
                    const firstName = columns[0].trim();
                    const lat = parseFloat(columns[1]);
                    const lng = parseFloat(columns[2]);
                    if (!isNaN(lat) && !isNaN(lng)) {
                        const marker = L.marker([lat, lng], { icon: playerIcon })
                            .bindPopup(`<b>${firstName}</b>`);
                        playerLocations.addLayer(marker); // Add marker to the cluster group
                    } else {
                        console.warn(`Skipping invalid row (bad coordinates): ${row}`);
                    }
                } else {
                    console.warn(`Skipping invalid row (wrong number of columns): ${row}`);
                }
            }
        }

        // --- 8. ADD LAYER CONTROL (LEGEND) ---
        const overlayMaps = {
            "<span class='player-icon player-icon-legend'></span> Players": playerLocations,
            "<span class='emoji-icon-legend'>⚽</span> Practice": practiceLocationLayer,
            "<span class='emoji-icon-legend'>🏆</span> Tournaments": tournamentLocations
        };

        // Add the layers to the map by default
        playerLocations.addTo(map);
        practiceLocationLayer.addTo(map);
        tournamentLocations.addTo(map);

        // Add the layer control to the map.
        L.control.layers(null, overlayMaps, { collapsed: false }).addTo(map);

    </script>
</body>
</html>
