<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activities Map</title>

    <!-- Leaflet CSS - Required for map styling -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>

    <style>
        /* Basic styling for the page */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Inter', sans-serif; /* Using a clean, modern font */
        }

        /* The map container must have a defined height */
        #map {
            height: 100%;
            width: 100%;
            background-color: #f0f0f0; /* Fallback color */
        }
        
        /* Base styling for our custom emoji icons */
        .emoji-icon {
            text-align: center;
            line-height: 1; /* Ensures emoji is centered vertically */
        }

        /* Custom icon for player locations from the CSV */
        .player-icon {
            background-color: #f97316; /* A nice orange color */
            border-radius: 50%; /* Makes it a circle */
            border: 1px solid #fff;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        /* Style for the layer control (legend) */
        .leaflet-control-layers {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
            padding: 10px;
        }
        
        /* Increase touch target size for mobile */
        .leaflet-control-layers-overlays label {
            display: flex;
            align-items: center;
            padding: 5px;
            font-size: 16px; /* Larger text */
            cursor: pointer;
        }

        /* Make the checkbox itself larger */
        .leaflet-control-layers-selector {
            transform: scale(1.5);
            margin-right: 15px; /* More space between checkbox and label */
        }

        /* Style for the orange dot icon in the legend */
        .player-icon-legend {
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-right: 8px;
        }

        /* Style for emoji icons in the legend */
        .emoji-icon-legend {
            font-size: 20px;
            margin-right: 8px;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>

    <!-- The div element where the map will be rendered -->
    <div id="map"></div>

    <!-- Leaflet JS - The core mapping library -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <!-- Esri Leaflet JS - Plugin to easily use Esri services (like basemaps) -->
    <script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"
            crossorigin=""></script>

    <script>
        // --- 1. INITIALIZE THE MAP ---
        const map = L.map('map', { minZoom: 10, maxZoom: 14 }).setView([38.88, -77.35], 10);

        // --- 2. ADD BASEMAP LAYER ---
        L.esri.basemapLayer('Imagery').addTo(map);
        L.esri.basemapLayer('ImageryLabels').addTo(map);

        // --- 3. DEFINE CUSTOM ICONS ---
        const createEmojiIcon = (emoji, size) => {
            return L.divIcon({
                html: `<span class="emoji-icon" style="font-size: ${size}px;">${emoji}</span>`,
                className: '',
                iconSize: [size, size],
                iconAnchor: [size / 2, size],
                popupAnchor: [0, -size]
            });
        };

        const playerIcon = L.divIcon({
            className: 'player-icon',
            iconSize: [10, 10]
        });
        
        const soccerIcon = createEmojiIcon('‚öΩ', 30);
        const icon1 = createEmojiIcon('1Ô∏è‚É£', 40);
        const icon2 = createEmojiIcon('2Ô∏è‚É£', 40);
        const icon3 = createEmojiIcon('3Ô∏è‚É£', 40);
        const icon4 = createEmojiIcon('4Ô∏è‚É£', 40);
        const icon5 = createEmojiIcon('5Ô∏è‚É£', 40);
        const icon6 = createEmojiIcon('6Ô∏è‚É£', 40);
        const icon7 = createEmojiIcon('7Ô∏è‚É£', 40);
        const icon8 = createEmojiIcon('8Ô∏è‚É£', 40);

        // --- 4. CREATE LAYER GROUPS ---
        const playerLocations = L.layerGroup();
        const practiceLocationLayer = L.layerGroup();
        const tournamentLocations = L.layerGroup();

        // --- 5. ADD SOCCER PRACTICE LOCATION ---
        const practiceLocation = {
            lat: 38.8484737,
            lng: -77.0869135,
            title: "Soccer Practice",
            icon: soccerIcon
        };
        L.marker([practiceLocation.lat, practiceLocation.lng], { icon: practiceLocation.icon })
            .addTo(practiceLocationLayer)
            .bindPopup(`<b>${practiceLocation.title}</b><br>Wednesday @ 6:30pm<br>Thursday @ 6:30pm<br>Sunday @ 4pm`);

        // --- 6. ADD TOURNAMENT LOCATIONS ---
        const tournaments = [
            // Batch 1
            { lat: 38.8163, lng: -76.7518, date: "Aug 23‚Äì24", location: "Upper Marlboro, MD", teams: "2015", icon: icon1 },
            { lat: 39.1819, lng: -77.3224, date: "Aug 23‚Äì24", location: "Boyds, MD", teams: "2018", icon: icon1 },
            { lat: 38.8526, lng: -77.3043, date: "Aug 30‚Äì31", location: "Fairfax, VA", teams: "2015, 2017", icon: icon2 },
            { lat: 38.8055, lng: -77.0434, date: "Oct 11‚Äì12", location: "Alexandria, VA", teams: "2015, 2016, 2017, 2018", icon: icon3 },
            { lat: 38.9342, lng: -77.1776, date: "Nov 22‚Äì23", location: "McLean, VA", teams: "2015, 2016, 2017, 2018", icon: icon4 },
            // Batch 2
            { lat: 38.88, lng: -77.09, date: "Feb 28 - Mar 1", location: "Arlington, VA", teams: "2015, 2016, 2017, 2018", icon: icon5 },
            { lat: 38.78, lng: -77.47, date: "Mar 28 - 29", location: "Manassas Park, VA", teams: "2015, 2016, 2017, 2018", icon: icon6 },
            { lat: 38.78, lng: -77.15, date: "May 23-24", location: "Franconia, VA", teams: "2015, 2016, 2017, 2018", icon: icon7 },
            { lat: 38.91, lng: -77.04, date: "Jun 20 - 21", location: "DC, DC", teams: "2015, 2016, 2017, 2018", icon: icon8 }
        ];

        tournaments.forEach(tourney => {
            const popupContent = `<b>${tourney.date}</b><br>${tourney.location}<br><i>Teams: ${tourney.teams}</i>`;
            L.marker([tourney.lat, tourney.lng], { icon: tourney.icon })
                .addTo(tournamentLocations)
                .bindPopup(popupContent);
        });

        // --- 7. FETCH AND PROCESS CSV DATA ---
        const csvUrl = 'https://cdn.jsdelivr.net/gh/yaboyanees/MerzCake@main/PLC.csv';

        fetch(csvUrl)
            .then(response => response.ok ? response.text() : Promise.reject('Network response was not ok'))
            .then(parseCSVAndAddMarkers)
            .catch(error => {
                console.error('There was a problem fetching the CSV data:', error);
                const errorDiv = L.control({position: 'topright'});
                errorDiv.onAdd = function (map) {
                    const div = L.DomUtil.create('div', 'info legend');
                    div.innerHTML = 'Could not load location data.';
                    div.style.backgroundColor = 'white';
                    div.style.padding = '10px';
                    div.style.borderRadius = '5px';
                    return div;
                };
                errorDiv.addTo(map);
            });
        
        function parseCSVAndAddMarkers(csvText) {
            const rows = csvText.trim().split('\n');
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i].trim();
                if (!row) continue;
                const columns = row.split(',');
                if (columns.length === 3) {
                    const firstName = columns[0].trim();
                    const lat = parseFloat(columns[1]);
                    const lng = parseFloat(columns[2]);
                    if (!isNaN(lat) && !isNaN(lng)) {
                        L.marker([lat, lng], { icon: playerIcon })
                            .addTo(playerLocations)
                            .bindPopup(`<b>${firstName}</b>`);
                    } else {
                        console.warn(`Skipping invalid row (bad coordinates): ${row}`);
                    }
                } else {
                    console.warn(`Skipping invalid row (wrong number of columns): ${row}`);
                }
            }
        }

        // --- 8. ADD LAYER CONTROL (LEGEND) ---
        // Define the overlay layers for the control, using HTML to add icons.
        const overlayMaps = {
            "<span class='player-icon player-icon-legend'></span> Players": playerLocations,
            "<span class='emoji-icon-legend'>‚öΩ</span> Practice": practiceLocationLayer,
            "<span class='emoji-icon-legend'>üèÜ</span> Tournaments": tournamentLocations
        };

        // Add the layers to the map by default
        playerLocations.addTo(map);
        practiceLocationLayer.addTo(map);
        tournamentLocations.addTo(map);

        // Add the layer control to the map.
        L.control.layers(null, overlayMaps, { collapsed: false }).addTo(map);

    </script>
</body>
</html>
